package fr.esisar.controller;
import fr.esisar.model.*;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import javax.management.Query;

import fr.esisar.controller.*;
public class FichierImageDAO extends FichierImage {
	
	public FichierImageDAO(String cheminAcces, String appareilPhoto, String objectif, double distanceFocal,
			String sensibiliteISO, String ouverture, double vitesseOburation, String client) {
		
		super(cheminAcces,appareilPhoto,objectif,distanceFocal,sensibiliteISO,ouverture,vitesseOburation,client);
	}
	
	public FichierImageDAO()  {
		super();
	}

	public static boolean InsererFichierImage(Connection Connection, String cheminAcces, String appareilPhoto,
			String objectif, String distanceFocal, String sensibiliteISO, String ouverture, String vitesseOburation,
			String adressMail) {
		Statement statement;
		ResultSet result = null;
		try {
			statement = Connection.createStatement();
			String quer1 = "INSERT INTO FichierImage (cheminAcces, appareilPhoto, objectif, distanceFocale, sensibiliteISO, ouverture, vitesseObturation,adresseMail) ";
			String quer2 = "VALUES ('" + cheminAcces + "', '" + appareilPhoto + "', '" + objectif + "', '" + distanceFocal + "', '"
					+ sensibiliteISO + "', '" + ouverture + "', '" + vitesseOburation +  "', '" + adressMail+"')";
			statement.executeUpdate(quer1 + quer2);
			System.out.println("fichier Image est bien ajoute!");
			return true;
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			System.out.println("Erreur : Fichier n'a pas pu etre insere");
			return false;
		}
		
		
		
	}
	public static boolean SupprimerFichierImage(Connection connect, String url, String email) throws ClassNotFoundException {
		Statement statement;
		String cheminAsupp = null;
		ResultSet result = null;
		ResultSet result2 = null;
		boolean del = true;
		// Verification existence de l'album a supprimer
		if (!VerificationAlbum(connect, url, email)) {
			return;
		}
		// Suppression de l'album
		System.out.println("Suppression du fichier image " + url + "...");
		statement = connect.createStatement();
		String sentence = "SELECT cheminAcces FROM Contient WHERE idAlbum = '" + idAlbum + "'";
		result = statement.executeQuery(sentence);
		System.out.println("Suppression des images contenues uniquement dans l'album " + idAlbum + "...");
		while (result.next()) {
			cheminAsupp = result.getString("cheminAcces");
			sentence = "SELECT idAlbum FROM Contient WHERE cheminAcces = '" + cheminAsupp + "'";
			result2 = statement.executeQuery(sentence);
			del = true;
			while (result2.next()) {
				if (idAlbum != result2.getInt("idAlbum")) {
					del = false;
				}
			}
			if (del) { // On supprime les fichiers image qui n'existent que dans
						// l'album que l'on supprime
				ContientDAO.RetirerFichierImagefromAlbum(connect, cheminAsupp, idAlbum);
				//FichierImageDAO.SupprimerFichierImage(connect, cheminAsupp);
			}
		}

		sentence = "SELECT cheminAcces FROM Contient WHERE idAlbum = '" + idAlbum + "'";
		result = statement.executeQuery(sentence);
		while (result.next()) {// On supprime les contient lies à l'album que
								// l'on souhaite supprimer
			ContientDAO.RetirerFichierImagefromAlbum(connect, result.getString("cheminAcces"), idAlbum);
		}
		sentence = "DELETE FROM Album WHERE idAlbum = '" + idAlbum + "'";
		statement.execute(sentence);
		System.out.println("La suppression de l'album " + idAlbum + " a été enregistrée.");
	}
	
	public static FichierImage findByURL(Connection connect,String url) throws SQLException {
		Statement statement;
		ResultSet result = null;
	
		statement = connect.createStatement();
		String sql = "SELECT * FROM FichierImage WHERE cheminAcces = \'" + url + "\' ";
		result = statement.executeQuery(sql);
		FichierImage image=new FichierImage();
		while (result.next()) {
			image.setCheminAcces(url);
			image.setAppareilPhoto(result.getString("appareilPhoto"));
			image.setObjectif(result.getString("objectif"));
			image.setDistanceFocal(Double.parseDouble(result.getString("distanceFocale")));
			image.setSensibiliteISO(result.getString("sensibiliteISO"));
				
			image.setOuverture(result.getString("ouverture"));
			image.setVitesseOburation(Double.parseDouble(result.getString("VitesseObturation")));  
		}
		return image;
	}
	
	public void afficherFichierImage(Connection connect,String idClient) throws SQLException {
		Statement statement;
		FichierImage image;
		ResultSet result = null;
			statement = connect.createStatement();
			String sql = "SELECT * FROM FichierImage WHERE adresseMail = '"+idClient+"'";
			result = statement.executeQuery(sql);
			 image=new FichierImage(idClient);
			while (result.next()) {
				image.setCheminAcces(result.getString("cheminAcces"));
				image.setAppareilPhoto(result.getString("appareilPhoto"));
				image.setObjectif(result.getString("objectif"));
				image.setDistanceFocal(Double.parseDouble(result.getString("distanceFocale")));
				image.setSensibiliteISO(result.getString("sensibiliteISO"));
				image.setOuverture(result.getString("ouverture"));
				image.setVitesseOburation(Double.parseDouble(result.getString("VitesseObturation")));  
				image.toString();
			}
		
	}

	public static boolean VerifierPresenceImage(Connection connect, String chemin) {
		Statement statement;
		boolean res = false;
		ResultSet result = null;
		try {
			statement = connect.createStatement();
			String sentence = "SELECT cheminAcces FROM FichierImage";
			result = statement.executeQuery(sentence);
			while (result.next()) {
				if(chemin.equals(result.getString("cheminAcces"))){
					res = true;
				}
			}
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return res;
	}

	public static boolean VerificationFichierImage(Connection connect, int url, String email) throws SQLException {
		Statement statement;
		ResultSet result = null;
		ResultSet result2 = null;
		boolean del = true;
		// Verification existence de l'album a supprimer
		statement = connect.createStatement();
		String sentence = "SELECT * FROM FichierImage WHERE adresseMail = '" + email + "'";
		result = statement.executeQuery(sentence);
		boolean valide = false;
		while (result.next()) {
			if (idAlbum == result.getInt("url"))
				valide = true;
		}
		if (!valide) {
			System.out.println(
					"Numero d'album invalide : le client " + email + " n'a pas d'album dont le numero est " + idAlbum);
		}
		return valide;
	}
	
}
