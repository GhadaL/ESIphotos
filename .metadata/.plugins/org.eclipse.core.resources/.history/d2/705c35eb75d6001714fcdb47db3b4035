package fr.esisar.controller;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import fr.esisar.model.Album;
import fr.esisar.model.FichierImage;

public class AlbumDAO extends Album{
	
	public AlbumDAO(String titre, String sousTitre) {
		super(titre, sousTitre);
	}

	public int CreationAlbum (Connection connect, String adresseMail)  throws ClassNotFoundException, SQLException {
		Statement statement;
		ResultSet result = null;
		statement = connect.createStatement();
		result = statement.executeQuery("SELECT MAX(idAlbum) FROM Album");
		result.next();
		if(result.getString(1) == null){
			idAlbum = 0;
		}
		else{
			idAlbum = Integer.parseInt(result.getString(1)) + 1;
		}
		String quer1 = "INSERT INTO Album (idAlbum, titre, sousTitre, adresseMail) ";
		String quer2 = "VALUES ('" + idAlbum + "', '" + titre + "', '" + sousTitre + "', '" + adresseMail + "')";
		result = statement.executeQuery(quer1 + quer2);
		System.out.println("L'album : "+idAlbum+" de titre : "+titre+" a ete cree");
		return idAlbum;
	}
	
	/*
	public void ajouterFichierImage(FichierImage image, int numOrdre, String titre, String commentaire) throws SQLException{
		Statement statement = null;
		ResultSet result = null;
		String quer1 = "INSERT INTO Contient (numOrdre,titre,commentaire,cheminAcces, idAlbum) ";
		String quer2 = "VALUES ('" + numOrdre + "', '" + titre + "', '" + commentaire + "', '" + image.getCheminAcces() + "', '" + idAlbum + "')";
		result = statement.executeQuery(quer1 + quer2);
	}
	*/
	
	public static void afficherListeAlbum(Connection connexion, String email) throws SQLException{
		System.out.println("Liste des albums du client " + email);
		Statement statement;
		ResultSet result = null;
		statement = connexion.createStatement();
		String sentence = "SELECT idAlbum, titre, sousTitre FROM Album";
		result = statement.executeQuery(sentence);
		while (result.next()) {
			System.out.println("idAlbum : "+result.getString("idAlbum")+", titre : "+result.getString("titre"));
		}
	}
	
	public static void modifierAlbum(Connection connexion, int idAlbum_int, String titre, String sousTitre, String email) throws SQLException{
		String idAlbum = ""+idAlbum_int;
		System.out.println("Liste des albums du client " + email);
		Statement statement;
		statement = connexion.createStatement();
		String sentence = "UPDATE Album SET titre = '"+titre+"', sousTitre = '"+sousTitre+"' WHERE customer_id = '"+idAlbum+"'";
		statement.execute(sentence);
		System.out.println("La modification de l'album +"+idAlbum+" a été enregistrée : titre = '"+titre+"', sousTitre = '"+sousTitre+"'");
	}
	
	public static void supprimerAlbum(Connection connexion, int idAlbum) throws SQLException, ClassNotFoundException{
		String idAlbumST = ""+idAlbum;
		System.out.println("Suppression de l'album " + idAlbum+" :");
		Statement statement;
		ResultSet result = null;
		ResultSet result2 = null;
		boolean del = true;
		statement = connexion.createStatement();
		String sentence = "SELECT cheminAcces FROM Contient WHERE idAlbum = '"+idAlbum+"'";
		result = statement.executeQuery(sentence);
		System.out.println("Suppression des images contenues uniquement dans l'album " + idAlbum +" :");
		while (result.next()) {
			sentence = "SELECT idAlbum FROM Contient WHERE cheminAcces = '"+result.getString("cheminAcces")+"'";
			result2 = statement.executeQuery(sentence);
			del = true;
			while (result.next()) {
				if (!(idAlbumST.equals(result2.getString("idAlbum")))){
					del = false;
				}
			}
			if (del){ //On supprime les fichiers image qui n'existent que dans l'album que l'on supprime
				ContientDAO.RetirerFichierImagefromAlbum(connexion, result.getString("cheminAcces"), idAlbum);
				FichierImageDAO.SupprimerFichierImage(connexion, result.getString("cheminAcces"));
			}
		}
		sentence = "SELECT cheminAcces FROM Contient WHERE idAlbum = '"+idAlbum+"'";
		result = statement.executeQuery(sentence);
		while (result.next()) {//On supprime les contient lies à l'album que l'on souhaite supprimer
			ContientDAO.RetirerFichierImagefromAlbum(connexion, result.getString("cheminAcces"), idAlbum);
		}
		sentence = "DELETE FROM Album WHERE idAlbum = '"+idAlbum+"'";
		statement.execute(sentence);
		System.out.println("La suppression de l'album +"+idAlbum+" a été enregistrée");
	}
	
}